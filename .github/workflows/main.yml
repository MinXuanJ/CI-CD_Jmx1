name: SLACK_NOTIFICATION

on: 
  push:
    branches: 
      - 'v[0-9]+.[0-9]+'
      - master
    paths-ignore:
      - '**/#NORUN*'
    
jobs:
  SLACK_NOTIFICATION: 
    runs-on: ubuntu-latest
    
    steps: 
    - 
      name: Checkout Repo
      id: checkout_repo
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - 
      name: Scan Pipeline Vunerability
      id: scan_pipeline
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        ignore-unfixed: true
        format: 'table'
        output: 'trivy-report.txt'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
     
    -
      name: Report Failure Messgae
      id: report_failure
      if: steps.scan_pipeline.outcome == 'failure'
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_TEST}}
        SLACK_TITLE: 'Pipeline Scan Failed'
        SLACK_MESSAGE: 'FAILED TRIVY SCAN'

    - 
      name: Display Trivy Report
      run: cat trivy-report.txt

    -
      name: Set up QEMU
      if: steps.scan_pipeline.outcome == 'success'
      uses: docker/setup-qemu-action@v3
    -
      name: Set up Docker Buildx
      if: steps.scan_pipeline.outcome == 'success'
      uses: docker/setup-buildx-action@v3
    -
      name: Login to Docker Hub
      if: steps.scan_pipeline.outcome == 'success'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    -
      name: Build and push
      if: steps.scan_pipeline.outcome == 'success'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: jmx139/jmx/go-fortune:${{ github.sha }}


      
    - 
      name: Upload Trivy Report
      id: upload_trivy_report
      uses: MeilCli/slack-upload-file@v3
      if: always()
      with:
        slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
        channel_id: ${{ secrets.SLACK_CHANNELID_TEST}}
        file_path: 'trivy-report.txt'
        initial_comment: 'Report by Jmx'
      
          